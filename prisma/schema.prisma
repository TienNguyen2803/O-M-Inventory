// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// MASTER DATA TABLES (24 tables)
// ============================================

// === VẬT TƯ (4 bảng) ===

model MaterialStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials Material[]

  @@map("material_statuses")
}

model MaterialCategory {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials Material[]

  @@map("material_categories")
}

model MaterialUnit {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials            Material[]
  warehouseItems       WarehouseItem[]
  materialRequestItems MaterialRequestItem[]
  purchaseRequestItems PurchaseRequestItem[] @relation("PurchaseItemUnit")
  biddingScopeItems    BiddingScopeItem[]    @relation("BiddingScopeUnit")
  inboundItems         InboundReceiptItem[]  @relation("InboundItemUnit")

  @@map("material_units")
}

model ManagementType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials Material[]

  @@map("management_types")
}

// === KHO (3 bảng) ===

model WarehouseArea {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations WarehouseLocation[]

  @@map("warehouse_areas")
}

model WarehouseType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations WarehouseLocation[]

  @@map("warehouse_types")
}

model WarehouseStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations WarehouseLocation[]

  @@map("warehouse_statuses")
}

// === NHÀ CUNG CẤP (3 bảng) ===

model SupplierType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suppliers Supplier[]

  @@map("supplier_types")
}

model PaymentTerm {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suppliers Supplier[]

  @@map("payment_terms")
}

model Currency {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suppliers Supplier[]

  @@map("currencies")
}

// === XUẤT XỨ (1 bảng) ===

model Country {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials Material[]
  suppliers Supplier[]

  @@map("countries")
}

// === YÊU CẦU VẬT TƯ (2 bảng) ===

model RequestPriority {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materialRequests MaterialRequest[]

  @@map("request_priorities")
}

model RequestStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materialRequests MaterialRequest[]
  purchaseRequests PurchaseRequest[] @relation("PurchaseStatus")

  @@map("request_statuses")
}

// === MUA SẮM (4 bảng) ===

model PurchaseSource {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_sources")
}

model PurchaseStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_statuses")
}

model MaterialOrigin {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseRequests PurchaseRequest[]

  @@map("material_origins")
}

model FundingSource {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseRequests PurchaseRequest[]

  @@map("funding_sources")
}

// === ĐẤU THẦU (2 bảng) ===

model BiddingMethod {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages BiddingPackage[]

  @@map("bidding_methods")
}

model BiddingStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages BiddingPackage[]

  @@map("bidding_statuses")
}

// === NHẬP KHO (3 bảng) ===

model InboundType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts InboundReceipt[]

  @@map("inbound_types")
}

model InboundStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts InboundReceipt[]

  @@map("inbound_statuses")
}

model InboundDocumentType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents InboundDocument[]

  @@map("inbound_document_types")
}

// === XUẤT KHO (2 bảng) ===

model OutboundPurpose {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("outbound_purposes")
}

model OutboundStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("outbound_statuses")
}

// === KIỂM KÊ (2 bảng) ===

model StocktakeStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stocktake_statuses")
}

model StocktakeArea {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stocktake_areas")
}

// === NGƯỜI DÙNG & NHẬT KÝ (2 bảng) ===

model UserStatus {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]

  @@map("user_statuses")
}

model ActivityAction {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("activity_actions")
}

// === PHÒNG BAN (1 bảng) ===

model Department {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  color     String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  materialRequests MaterialRequest[]
  purchaseRequests PurchaseRequest[] @relation("PurchaseDepartment")

  @@map("departments")
}

// ============================================
// BUSINESS DATA TABLES
// ============================================

model Material {
  id             String   @id @default(uuid())
  name           String
  nameEn         String?
  code           String   @unique
  evnCode        String?
  partNo         String
  serialNumber   String?
  
  // FK Relations to Master Data
  managementTypeId String
  categoryId       String
  unitId           String
  statusId         String
  countryId        String?
  
  managementType   ManagementType   @relation(fields: [managementTypeId], references: [id])
  materialCategory MaterialCategory @relation(fields: [categoryId], references: [id])
  materialUnit     MaterialUnit     @relation(fields: [unitId], references: [id])
  materialStatus   MaterialStatus   @relation(fields: [statusId], references: [id])
  country          Country?         @relation(fields: [countryId], references: [id])
  
  description    String?
  stock          Int      @default(0)
  manufacturer   String?
  minStock       Int?
  maxStock       Int?
  technicalSpecs Json?
  location       String?
  stockAge       String?
  supplierWarranty String?
  serviceWarranty  String?
  chassisPn      String?
  chassisSn      String?
  originAsPerCustomer String?
  originOnDocs   String?
  warrantyCount  Int?
  lifespan       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  requestItems MaterialRequestItem[]
  purchaseRequestItems PurchaseRequestItem[] @relation("PurchaseItemMaterial")
  biddingScopeItems    BiddingScopeItem[]    @relation("BiddingScopeMaterial")
  inboundItems         InboundReceiptItem[]  @relation("InboundItemMaterial")

  @@map("materials")
}

model Supplier {
  id            String   @id @default(uuid())
  code          String   @unique
  taxCode       String
  name          String
  address       String

  // FK Relations to Master Data
  countryId     String
  typeId        String
  paymentTermId String
  currencyId    String

  country       Country      @relation(fields: [countryId], references: [id])
  supplierType  SupplierType @relation(fields: [typeId], references: [id])
  paymentTerm   PaymentTerm  @relation(fields: [paymentTermId], references: [id])
  currency      Currency     @relation(fields: [currencyId], references: [id])

  status        String   @default("Active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contacts               SupplierContact[]
  suggestedPurchaseItems PurchaseRequestItem[] @relation("PurchaseSuggestedSupplier")
  biddingParticipations  BiddingParticipant[]  @relation("BiddingSupplier")
  wonBiddings            BiddingPackage[]      @relation("BiddingWinner")
  inboundReceipts        InboundReceipt[]      @relation("InboundSupplier")

  @@map("suppliers")
}

model SupplierContact {
  id         String   @id @default(uuid())
  supplierId String
  name       String
  position   String
  email      String
  phone      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("supplier_contacts")
}

model WarehouseLocation {
  id         String   @id @default(uuid())
  code       String   @unique
  name       String
  areaId     String
  typeId     String
  statusId   String
  barcode    String?
  maxWeight  Float?
  dimensions String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  area   WarehouseArea   @relation(fields: [areaId], references: [id])
  type   WarehouseType   @relation(fields: [typeId], references: [id])
  status WarehouseStatus @relation(fields: [statusId], references: [id])
  items  WarehouseItem[]
  inboundItems InboundReceiptItem[] @relation("InboundItemLocation")

  @@map("warehouse_locations")
}

model WarehouseItem {
  id           String   @id @default(uuid())
  locationId   String
  materialId   String
  materialCode String
  materialName String
  quantity     Int
  unitId       String
  batchSerial  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  location WarehouseLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  unit     MaterialUnit      @relation(fields: [unitId], references: [id])

  @@map("warehouse_items")
}

model MaterialRequest {
  id           String   @id @default(uuid())
  requestCode  String   @unique

  // FK Relations
  requesterId  String
  departmentId String
  priorityId   String
  statusId     String
  approverId   String?

  requester    User            @relation("RequesterRequests", fields: [requesterId], references: [id])
  department   Department      @relation(fields: [departmentId], references: [id])
  priority     RequestPriority @relation(fields: [priorityId], references: [id])
  status       RequestStatus   @relation(fields: [statusId], references: [id])
  approver     User?           @relation("ApproverRequests", fields: [approverId], references: [id])

  reason       String
  requestDate  DateTime
  workOrder    String?
  step         Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  items MaterialRequestItem[]

  @@map("material_requests")
}

model MaterialRequestItem {
  id                String   @id @default(uuid())
  requestId         String
  materialId        String
  unitId            String
  requestedQuantity Int
  stock             Int
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  request  MaterialRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  material Material        @relation(fields: [materialId], references: [id])
  unit     MaterialUnit    @relation(fields: [unitId], references: [id])

  @@map("material_request_items")
}

model PurchaseRequest {
  id            String   @id @default(uuid())
  requestCode   String   @unique

  // FK Relations
  requesterId     String
  departmentId    String
  statusId        String
  sourceId        String
  fundingSourceId String

  requester     User            @relation("PurchaseRequester", fields: [requesterId], references: [id])
  department    Department      @relation("PurchaseDepartment", fields: [departmentId], references: [id])
  status        RequestStatus   @relation("PurchaseStatus", fields: [statusId], references: [id])
  source        MaterialOrigin  @relation(fields: [sourceId], references: [id])
  fundingSource FundingSource   @relation(fields: [fundingSourceId], references: [id])

  description   String
  totalAmount   Float
  step          Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items           PurchaseRequestItem[]
  biddingPackages BiddingPurchaseRequest[]
  inboundReceipts InboundReceipt[]

  @@map("purchase_requests")
}

model PurchaseRequestItem {
  id                  String   @id @default(uuid())
  requestId           String
  materialId          String?
  name                String
  unitId              String
  quantity            Int
  estimatedPrice      Float
  suggestedSupplierId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  request           PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  material          Material?       @relation("PurchaseItemMaterial", fields: [materialId], references: [id])
  unit              MaterialUnit    @relation("PurchaseItemUnit", fields: [unitId], references: [id])
  suggestedSupplier Supplier?       @relation("PurchaseSuggestedSupplier", fields: [suggestedSupplierId], references: [id])

  @@map("purchase_request_items")
}

// === BIDDING PACKAGE (Gói thầu) ===

model BiddingPackage {
  id                String   @id @default(uuid())
  packageCode       String   @unique  // TB-2026-01
  name              String

  // FK Relations
  methodId          String
  statusId          String
  createdById       String
  winnerId          String?  // Nhà thầu trúng thầu

  method            BiddingMethod  @relation(fields: [methodId], references: [id])
  status            BiddingStatus  @relation(fields: [statusId], references: [id])
  createdBy         User           @relation("BiddingCreator", fields: [createdById], references: [id])
  winner            Supplier?      @relation("BiddingWinner", fields: [winnerId], references: [id])

  estimatedBudget   Float
  openDate          DateTime
  closeDate         DateTime
  step              Int      @default(1)  // 1-4 for stepper
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  purchaseRequests  BiddingPurchaseRequest[]
  participants      BiddingParticipant[]
  scopeItems        BiddingScopeItem[]

  @@map("bidding_packages")
}

// === N:M with Purchase Request ===
model BiddingPurchaseRequest {
  id                String   @id @default(uuid())
  biddingPackageId  String
  purchaseRequestId String

  biddingPackage    BiddingPackage   @relation(fields: [biddingPackageId], references: [id], onDelete: Cascade)
  purchaseRequest   PurchaseRequest  @relation(fields: [purchaseRequestId], references: [id])

  createdAt         DateTime @default(now())

  @@unique([biddingPackageId, purchaseRequestId])
  @@map("bidding_purchase_requests")
}

// === Scope Items (từ PR items) ===
model BiddingScopeItem {
  id                String   @id @default(uuid())
  biddingPackageId  String
  materialId        String?
  name              String   // Tên hạng mục
  unitId            String
  quantity          Float
  estimatedAmount   Float

  biddingPackage    BiddingPackage @relation(fields: [biddingPackageId], references: [id], onDelete: Cascade)
  material          Material?      @relation("BiddingScopeMaterial", fields: [materialId], references: [id])
  unit              MaterialUnit   @relation("BiddingScopeUnit", fields: [unitId], references: [id])

  quotations        BidQuotation[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("bidding_scope_items")
}

// === Nhà thầu tham gia ===
model BiddingParticipant {
  id                String   @id @default(uuid())
  biddingPackageId  String
  supplierId        String

  biddingPackage    BiddingPackage @relation(fields: [biddingPackageId], references: [id], onDelete: Cascade)
  supplier          Supplier       @relation("BiddingSupplier", fields: [supplierId], references: [id])

  invitedAt         DateTime @default(now())
  submittedAt       DateTime?
  isSubmitted       Boolean  @default(false)

  // Scoring
  technicalScore    Float?
  priceScore        Float?
  totalScore        Float?
  rank              Int?

  quotations        BidQuotation[]

  @@unique([biddingPackageId, supplierId])
  @@map("bidding_participants")
}

// === Báo giá từng hạng mục của nhà thầu ===
model BidQuotation {
  id                  String   @id @default(uuid())
  participantId       String
  scopeItemId         String

  participant         BiddingParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  scopeItem           BiddingScopeItem   @relation(fields: [scopeItemId], references: [id])

  unitPrice           Float
  quantity            Float
  totalPrice          Float
  notes               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([participantId, scopeItemId])
  @@map("bid_quotations")
}

model InboundReceipt {
  id          String   @id @default(uuid())
  receiptCode String   @unique  // PNK-2026-001

  // FK Relations
  typeId              String
  statusId            String
  supplierId          String
  purchaseRequestId   String?    // Optional - có thể nhập thủ công
  createdById         String

  type            InboundType       @relation(fields: [typeId], references: [id])
  status          InboundStatus     @relation(fields: [statusId], references: [id])
  supplier        Supplier          @relation("InboundSupplier", fields: [supplierId], references: [id])
  purchaseRequest PurchaseRequest?  @relation(fields: [purchaseRequestId], references: [id])
  createdBy       User              @relation("InboundCreator", fields: [createdById], references: [id])

  referenceCode   String?    // Mã tham chiếu thủ công (nếu không có PR)
  inboundDate     DateTime
  notes           String?
  step            Int        @default(1)  // 1-4 for stepper

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     InboundReceiptItem[]
  documents InboundDocument[]

  @@map("inbound_receipts")
}

model InboundReceiptItem {
  id        String   @id @default(uuid())
  receiptId String

  // FK Relations
  materialId String
  unitId     String
  locationId String?   // Nullable - assign when receiving

  material   Material           @relation("InboundItemMaterial", fields: [materialId], references: [id])
  unit       MaterialUnit       @relation("InboundItemUnit", fields: [unitId], references: [id])
  location   WarehouseLocation? @relation("InboundItemLocation", fields: [locationId], references: [id])
  receipt    InboundReceipt     @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  orderedQuantity   Int
  receivedQuantity  Int       @default(0)
  receivingQuantity Int       @default(0)
  serialBatch       String?
  kcs               Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inbound_receipt_items")
}

model InboundDocument {
  id        String   @id @default(uuid())
  receiptId String
  typeId    String

  type    InboundDocumentType @relation(fields: [typeId], references: [id])
  receipt InboundReceipt      @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  fileName  String
  fileUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inbound_documents")
}

model OutboundVoucher {
  id                String   @id @default(uuid())
  voucherCode       String   @unique
  purpose           String
  materialRequestId String
  department        String
  receiverName      String
  reason            String
  status            String
  step              Int      @default(1)
  issueDate         DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items OutboundVoucherItem[]

  @@map("outbound_vouchers")
}

model OutboundVoucherItem {
  id                     String   @id @default(uuid())
  voucherId              String
  materialId             String
  materialCode           String
  materialName           String
  unit                   String
  requestedQuantity      Int
  issuedQuantity         Int
  pickLocationSuggestion String?
  actualSerial           String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  voucher OutboundVoucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@map("outbound_voucher_items")
}

model StockTake {
  id        String   @id @default(uuid())
  takeCode  String   @unique
  name      String
  date      DateTime
  status    String
  area      String
  leader    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  results StockTakeResult[]

  @@map("stock_takes")
}

model StockTakeResult {
  id             String   @id @default(uuid())
  stockTakeId    String
  materialId     String
  materialCode   String
  materialName   String
  location       String
  bookQuantity   Int
  actualQuantity Int
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  stockTake StockTake @relation(fields: [stockTakeId], references: [id], onDelete: Cascade)

  @@map("stock_take_results")
}

model User {
  id           String   @id @default(uuid())
  employeeCode String   @unique
  name         String
  email        String   @unique
  phone        String?
  departmentId String
  statusId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department   Department @relation(fields: [departmentId], references: [id])
  userStatus   UserStatus @relation(fields: [statusId], references: [id])
  userRoles    UserRole[]

  // MaterialRequest relations
  requestedMaterialRequests MaterialRequest[] @relation("RequesterRequests")
  approvedMaterialRequests  MaterialRequest[] @relation("ApproverRequests")

  // PurchaseRequest relations
  purchaseRequests PurchaseRequest[] @relation("PurchaseRequester")

  // BiddingPackage relations
  createdBiddingPackages BiddingPackage[] @relation("BiddingCreator")

  // InboundReceipt relations
  createdInboundReceipts InboundReceipt[] @relation("InboundCreator")

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  userCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles          UserRole[]
  roleFeatureActions RoleFeatureAction[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ============== Permission Management ==============

model Action {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  featureActions FeatureAction[]
  @@map("actions")
}

model Feature {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  groupCode String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  featureActions FeatureAction[]
  @@map("features")
}

model FeatureAction {
  id        String   @id @default(uuid())
  featureId String
  actionId  String
  feature   Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)
  action    Action   @relation(fields: [actionId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  roleFeatureActions RoleFeatureAction[]

  @@unique([featureId, actionId])
  @@map("feature_actions")
}

model RoleFeatureAction {
  id              String        @id @default(uuid())
  roleId          String
  featureActionId String
  createdAt       DateTime      @default(now())

  role          Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  featureAction FeatureAction @relation(fields: [featureActionId], references: [id], onDelete: Cascade)

  @@unique([roleId, featureActionId])
  @@index([roleId])
  @@index([featureActionId])
  @@map("role_feature_actions")
}

model ActivityLog {
  id         String   @id @default(uuid())
  timestamp  DateTime @default(now())
  userName   String
  userAvatar String?
  action     String
  targetType String
  targetId   String
  details    String
  createdAt  DateTime @default(now())

  @@index([timestamp])
  @@map("activity_logs")
}

model InventoryLog {
  id           String   @id @default(uuid())
  materialId   String
  materialName String
  quantity     Int
  type         String   // inbound | outbound
  date         DateTime
  actor        String
  createdAt    DateTime @default(now())

  @@index([date])
  @@map("inventory_logs")
}
